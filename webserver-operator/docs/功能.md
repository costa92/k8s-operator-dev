# 实现功能

 需要为 crd spec 添加一些状态字段，crd 与 api 中的 webserver_types.go 文件是同步的，所以需要在 webserver_types.go 中添加状态字段，然后执行 make manifests 命令，生成新的 CRD yaml 文件，然后执行 make install 命令，将新的 CRD yaml 文件安装到集群中，
 最后执行 make run 命令，启动 operator，这样 operator 就能够感知到 CRD 的变化了。
 
在 webserver_types.go 中添加状态字段

```go
// WebServerSpec defines the desired state of WebServer
type WebServerSpec struct {
    // INSERT ADDITIONAL SPEC FIELDS - desired state of cluster
    // Important: Run "make" to regenerate code after modifying this file
	Replicas int `json:"replicas,omitempty"`
	
	Image string `json:"image,omitempty"`
    // Foo is an example field of WebServer. Edit WebServer_types.go to remove/update
    Foo string `json:"foo,omitempty"`
}
```

保存修改后，执行make manifests重新生成config/crd/bases/my.domain_webservers.yaml
```yaml
          spec:
            description: WebServerSpec defines the desired state of WebServer
            properties:
              foo:
                description: Foo is an example field of WebServer. Edit webserver_types.go
                  to remove/update
                type: string
              image:
                description: Image is the Docker image to run for the webserver
                type: string
              replicas:
                description: Replicas is the number of replicas of the webserver
                type: integer
            type: object
```

执行make install安装CRD到集群中
```bash
$make install
test -s /home/hellotalk/code/go/src/github.com/costa92/operation/webserver-operator/bin/controller-gen && /home/hellotalk/code/go/src/github.com/costa92/operation/webserver-operator/bin/controller-gen --version | grep -q v0.11.1 || \
GOBIN=/home/hellotalk/code/go/src/github.com/costa92/operation/webserver-operator/bin go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.11.1
/home/hellotalk/code/go/src/github.com/costa92/operation/webserver-operator/bin/controller-gen rbac:roleName=manager-role crd webhook paths="./..." output:crd:artifacts:config=config/crd/bases
/home/hellotalk/code/go/src/github.com/costa92/operation/webserver-operator/bin/kustomize build config/crd | kubectl apply -f -
customresourcedefinition.apiextensions.k8s.io/webservers.my.domain created
```
查看安装的CRD
```bash
$kubectl get crd|grep webserver
webservers.my.domain   2023-08-18T03:50:33Z
```

controller中会为CRD实例创建对应deployment和service，这样就要求controller有操作deployments和services的权限，
这样就需要我们修改role.yaml，增加service account: controller-manager 操作deployments和services的权限
```yaml
// config/rbac/role.yaml
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
 creationTimestamp: null
 name: manager-role
rules:
 - apiGroups:
    - my.domain
   resources:
    - webservers
   verbs:
    - create
    - delete
    - get
    - list
    - patch
    - update
    - watch
 - apiGroups:
    - my.domain
   resources:
    - webservers/finalizers
   verbs:
    - update
 - apiGroups:
    - my.domain
   resources:
    - webservers/status
   verbs:
    - get
    - patch
    - update
 - apiGroups:
    - apps
   resources:
    - deployments
   verbs:
    - create
    - delete
    - get
    - list
    - patch
    - update
    - watch
 - apiGroups:
    - apps
    - ""
   resources:
    - services
   verbs:
    - create
    - delete
    - get
    - list
    - patch
    - update
    - watch
```
修改后的role.yaml先放在这里，后续与controller一并部署到k8s上

kubebuilder为我们搭好了controller的代码架子，我们只需要在controllers/webserver_controller.go中实现WebServerReconciler的Reconcile方法即可。
下面是Reconcile的一个简易流程图，结合这幅图理解代码就容易的多了：
![Reconcile](https://tonybai.com/wp-content/uploads/developing-kubernetes-operators-in-go-part1-8.png)

下面是对应的Reconcile方法的代码
```go
```

> 注意: 在 Controller 中需要添加一下代码：

```go 
//+kubebuilder:rbac:groups=my.domain,resources=webservers,verbs=get;list;watch;create;update;patch;delete
//+kubebuilder:rbac:groups=my.domain,resources=webservers/status,verbs=get;update;patch
//+kubebuilder:rbac:groups=my.domain,resources=webservers/finalizers,verbs=update
// add role 不然执行代码时候，会覆盖role 没有权限
//+kubebuilder:rbac:groups=apps,resources=deployments,verbs=get;list;watch;create;update;patch;delete
//+kubebuilder:rbac:groups=apps,resources=deployments/status,verbs=get
//+kubebuilder:rbac:groups=core,resources=services,verbs=get;list;watch;create;update;patch;delete
//+kubebuilder:rbac:groups=core,resources=services/status,verbs=get

// Reconcile is part of the main kubernetes reconciliation loop which aims to
// move the current state of the cluster closer to the desired state.
// TODO(user): Modify the Reconcile function to compare the state specified by
// the WebServer object against the actual cluster state, and then
// perform operations to make the cluster state reflect the state specified by
// the user.
//
// For more details, check Reconcile and its Result here:
// - https://pkg.go.dev/sigs.k8s.io/controller-runtime@v0.14.1/pkg/reconcile
func (r *WebServerReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) {
   ...
}	
```

